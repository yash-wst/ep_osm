
-module(dig_mm_ep_osm_bundle).
-compile(export_all).
-include("records.hrl").
-include_lib("nitrogen_core/include/wf.hrl").


%------------------------------------------------------------------------------
% main
%------------------------------------------------------------------------------

main() ->
	ita:auth(?APPOSM, ?MODULE, ?AKIT(#template {file="lib/itx/priv/static/templates/html/entered_nomenu.html"})).

title() ->
	?LN("OSM Bundles").

heading() ->
	title().

form() ->
	ep_osm_bundle.

digmm_actions() -> [
].

%------------------------------------------------------------------------------
% records
%------------------------------------------------------------------------------


%------------------------------------------------------------------------------
% fields
%------------------------------------------------------------------------------


%------------------------------------------------------------------------------
% options
%------------------------------------------------------------------------------


%------------------------------------------------------------------------------
% fs
%------------------------------------------------------------------------------


%------------------------------------------------------------------------------
% fs - group
%------------------------------------------------------------------------------

fields(ep_osm_bundle, _Fs) ->
	ep_osm_bundle:fs(form).



%------------------------------------------------------------------------------
% access
%------------------------------------------------------------------------------
access(_, ?APPOSM_ADMIN) -> true;
access(_, ?APPOSM_ANPADMIN) -> true;
access(_, ?APPOSM_RECEIVER) -> true;
access(_, _) -> false.



%------------------------------------------------------------------------------
% function - get
%------------------------------------------------------------------------------

get() ->
	#dig {
		mode=get_mode(),
		module=?MODULE,
		filters=[
			?COREXS(season_fk),
			?OSMBDL(osm_exam_fk),
			?OSMBDL(receivedby),
			?OSMBDL(createdby),
			?OSMBDL(inwardstate),
			?OSMBDL(scanningstate),
			?OSMBDL(uploadstate),
			?OSMBDL(inward_date),
			?OSMBDL(scanned_date),
			?OSMBDL(uploaded_date)
		],
		events=[
			ite:button(export, "CSV", {itx, {dig_mm, export}})
		],
		config=[
			{responsive_type, scroll}
		],
		size=25
	}.


get_mode() ->
	case erlang:get(minijobcontext) of
		undefined ->
			?VIEW;
		_ ->
			?EXPORT
	end.



%------------------------------------------------------------------------------
% function - title
%------------------------------------------------------------------------------
digtitle() ->
	?LN("OSM Bundles").



%------------------------------------------------------------------------------
% function - init
%------------------------------------------------------------------------------
init() ->
	ok.


%------------------------------------------------------------------------------
% function - fetch
%------------------------------------------------------------------------------

%..............................................................................
%
% []
%
%..............................................................................
fetch(D, From, Size, Fs) ->
	dig_mm:fetch(D, From, Size, Fs).



%------------------------------------------------------------------------------
% layouts
%------------------------------------------------------------------------------
layout() ->
	dig_mm:layout(?MODULE).



%------------------------------------------------------------------------------
% events
%------------------------------------------------------------------------------
event({itx, {dig_mm, export} = E}) ->
	dig_ep_osm_bundle_daily_report:assert_season_required(),
	ite:event(E);

event(action_new) ->
	helper_ui:flash(error, "Cannot create bundle here. Please use DTP login.", 5);

event(E) ->
	dig_mm:event(E).

start_upload_event(Event) ->
	dig_mm:start_upload_event(Event).

finish_upload_event(Tag, AttachmentName, LocalFileData, Node) ->
	dig_mm:finish_upload_event(Tag, AttachmentName, LocalFileData, Node).

%------------------------------------------------------------------------------
% assertions
%------------------------------------------------------------------------------


%------------------------------------------------------------------------------
% save
%------------------------------------------------------------------------------

%
% override before create function
%
before_create(_FsToSave) ->

	?ASSERT(
		false,
		"cannot create bundle from this ui. it needs to be created from osm exam"
	).


%
% override before save function
%
before_save(FsToSave, _FsAll, _Doc) ->
	FsToSave.


%------------------------------------------------------------------------------
% handler
%------------------------------------------------------------------------------



%------------------------------------------------------------------------------
% misc
%------------------------------------------------------------------------------



%------------------------------------------------------------------------------
% end
%------------------------------------------------------------------------------
